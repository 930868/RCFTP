name: C-FTP Test

on:
  push: 
    branches:
      "main"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies (if needed)
      run: sudo apt-get update

    - name: Build client
      run: |
        cd rcftpclient
        make clean
        make all
        cd ..
    - name: Build server
      run: |
        cd rcftpd
        make clean
        make all
        cd ..
      
    - name: Generate random file (20 KB)
      run: dd if=/dev/urandom of=mificheroaleatorio bs=1000 count=20

    - name: Start server in background
      run: |
        ./rcftpd/rcftpd -p 32002 &
        echo $! > server_pid

    - name: Give server time to start
      run: sleep 1

    - name: Run client (pipe file)
      run: |
        cat mificheroaleatorio | ./rcftpclient/rcftpclient -v -a1 -d 127.0.0.1 -p 32002

    - name: Kill server
      run: kill "$(cat server_pid)"

    - name: Check received file
      run: |
        if cmp -s mificheroaleatorio f_recibido; then
          echo "OK: Files match"
        else
          echo "ERROR: Files differ"
          exit 1
        fi
